# AI工作流编排系统设计文档

## 1. 系统概述

### 1.1 项目定位
本项目是一个**基于SpringBoot+MCP+流程引擎的多Agent编排系统**，类似Dify但核心差异化在于支持MCP（Model Context Protocol）协议，为企业提供标准化的AI工作流编排能力。

### 1.2 核心价值
- 🎯 **MCP协议支持**：标准化AI模型交互，支持阿里通义千问等国内MCP模型
- ⚙️ **自研流程引擎**：可视化流程设计，多Agent协作编排
- 🚀 **企业级部署**：高可用、可扩展的生产环境支持
- 🔗 **开放生态**：标准化接口，易于集成第三方工具和服务

### 1.3 技术栈
- **后端框架**：Spring Boot 3.5+, Java 17
- **协议标准**：MCP (Model Context Protocol) 
- **数据存储**：MySQL 8.0+, Redis 7.0+
- **消息队列**：Redis Stream / RabbitMQ
- **容器化**：Docker + Kubernetes

---

## 2. 系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    用户接入层                                │
├─────────────────┬─────────────────┬─────────────────────────┤
│   Web管理界面    │   REST API      │   WebSocket实时通信      │
└─────────────────┴─────────────────┴─────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                    网关层                                   │
├─────────────────┬─────────────────┬─────────────────────────┤
│   API Gateway   │   认证授权       │   限流熔断              │
└─────────────────┴─────────────────┴─────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                  核心业务层                                 │
├─────────────────┬─────────────────┬─────────────────────────┤
│  🔗 MCP协议引擎  │  ⚙️ 流程编排引擎 │   Agent管理器           │
└─────────────────┴─────────────────┴─────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                  数据存储层                                 │
├─────────────────┬─────────────────┬─────────────────────────┤
│   MySQL主库     │   Redis缓存     │   文件存储              │
└─────────────────┴─────────────────┴─────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                  AI模型层                                   │
├─────────────────┬─────────────────┬─────────────────────────┤
│  阿里通义千问    │   百度文心      │   其他MCP模型           │
└─────────────────┴─────────────────┴─────────────────────────┘
```

### 2.2 核心模块架构

#### 2.2.1 MCP协议引擎模块
```
MCP引擎
├── MCP服务器 (MCPServer)
│   ├── 协议处理器 (ProtocolHandler)
│   ├── 连接管理器 (ConnectionManager) 
│   └── 消息路由器 (MessageRouter)
├── MCP客户端 (MCPClient)
│   ├── 模型连接池 (ModelConnectionPool)
│   ├── 请求管理器 (RequestManager)
│   └── 响应处理器 (ResponseHandler)
└── 工具管理器 (ToolManager)
    ├── 工具注册中心 (ToolRegistry)
    ├── 权限控制器 (PermissionController)
    └── 资源管理器 (ResourceManager)
```

#### 2.2.2 流程编排引擎模块
```
流程引擎
├── 流程设计器 (ProcessDesigner)
│   ├── BPMN解析器 (BPMNParser)
│   ├── 流程验证器 (ProcessValidator)
│   └── 模板管理器 (TemplateManager)
├── 流程执行器 (ProcessExecutor)
│   ├── 任务调度器 (TaskScheduler)
│   ├── 状态管理器 (StateManager)
│   └── 事件处理器 (EventHandler)
└── Agent管理器 (AgentManager)
    ├── Agent注册中心 (AgentRegistry)
    ├── 负载均衡器 (LoadBalancer)
    └── 健康检查器 (HealthChecker)
```

---

## 3. 核心模块详细设计

### 3.1 MCP协议引擎设计

#### 3.1.1 MCP服务器 (MCPServer)
```java
@Component
@Slf4j
public class MCPServer {
    
    @Autowired
    private ProtocolHandler protocolHandler;
    
    @Autowired
    private ConnectionManager connectionManager;
    
    @Autowired
    private MessageRouter messageRouter;
    
    /**
     * 启动MCP服务器
     */
    public void start() {
        // 初始化协议处理器
        // 启动连接监听
        // 注册消息路由
    }
    
    /**
     * 处理MCP请求
     */
    public MCPResponse handleRequest(MCPRequest request) {
        // 验证请求格式
        // 路由到对应处理器
        // 返回标准响应
    }
}
```

#### 3.1.2 模型适配器设计
```java
public interface ModelAdapter {
    
    /**
     * 连接AI模型
     */
    MCPConnection connect(ModelConfig config);
    
    /**
     * 发送MCP请求
     */
    MCPResponse sendRequest(MCPRequest request);
    
    /**
     * 调用工具
     */
    ToolResponse invokeTool(ToolRequest toolRequest);
    
    /**
     * 访问资源
     */
    ResourceResponse accessResource(ResourceRequest resourceRequest);
}

@Component
public class AliTongyiAdapter implements ModelAdapter {
    // 阿里通义千问MCP适配实现
}

@Component  
public class BaiduWenxinAdapter implements ModelAdapter {
    // 百度文心一言MCP适配实现
}
```

### 3.2 流程编排引擎设计

#### 3.2.1 流程定义模型
```java
@Entity
@Table(name = "process_definition")
public class ProcessDefinition {
    
    @Id
    private String processId;
    
    @Column(name = "process_name")
    private String processName;
    
    @Column(name = "bpmn_xml", columnDefinition = "TEXT")
    private String bpmnXml;
    
    @Column(name = "version")
    private Integer version;
    
    @Column(name = "status")
    @Enumerated(EnumType.STRING)
    private ProcessStatus status;
    
    @OneToMany(mappedBy = "processDefinition", cascade = CascadeType.ALL)
    private List<ProcessInstance> instances;
    
    // getter/setter
}
```

#### 3.2.2 任务调度器设计
```java
@Component
@Slf4j
public class TaskScheduler {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private AgentManager agentManager;
    
    /**
     * 提交任务到队列
     */
    public void submitTask(Task task) {
        // 任务优先级排序
        // 添加到Redis队列
        // 触发执行器
    }
    
    /**
     * 执行任务
     */
    @Async("taskExecutor")
    public CompletableFuture<TaskResult> executeTask(Task task) {
        try {
            // 选择合适的Agent
            Agent agent = agentManager.selectAgent(task);
            
            // 执行任务
            TaskResult result = agent.execute(task);
            
            // 更新任务状态
            updateTaskStatus(task.getId(), TaskStatus.COMPLETED);
            
            return CompletableFuture.completedFuture(result);
        } catch (Exception e) {
            log.error("任务执行失败: {}", task.getId(), e);
            updateTaskStatus(task.getId(), TaskStatus.FAILED);
            return CompletableFuture.failedFuture(e);
        }
    }
}
```

### 3.3 Agent管理器设计

#### 3.3.1 Agent接口定义
```java
public interface Agent {
    
    /**
     * Agent唯一标识
     */
    String getAgentId();
    
    /**
     * Agent能力描述
     */
    AgentCapability getCapability();
    
    /**
     * 执行任务
     */
    TaskResult execute(Task task);
    
    /**
     * 健康检查
     */
    HealthStatus getHealthStatus();
}

@Component
public class LLMAgent implements Agent {
    
    @Autowired
    private MCPClient mcpClient;
    
    @Override
    public TaskResult execute(Task task) {
        // 通过MCP调用AI模型
        MCPRequest request = buildMCPRequest(task);
        MCPResponse response = mcpClient.sendRequest(request);
        return parseTaskResult(response);
    }
}
```

---

## 4. 数据库设计

### 4.1 核心表结构

#### 4.1.1 流程定义表
```sql
CREATE TABLE process_definition (
    process_id VARCHAR(64) PRIMARY KEY,
    process_name VARCHAR(255) NOT NULL,
    process_key VARCHAR(255) NOT NULL,
    bpmn_xml TEXT,
    version INT DEFAULT 1,
    status ENUM('DRAFT', 'ACTIVE', 'SUSPENDED', 'DELETED') DEFAULT 'DRAFT',
    created_by VARCHAR(64),
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_process_key (process_key),
    INDEX idx_status (status)
);
```

#### 4.1.2 流程实例表
```sql
CREATE TABLE process_instance (
    instance_id VARCHAR(64) PRIMARY KEY,
    process_id VARCHAR(64) NOT NULL,
    business_key VARCHAR(255),
    status ENUM('RUNNING', 'COMPLETED', 'FAILED', 'SUSPENDED') DEFAULT 'RUNNING',
    start_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    end_time TIMESTAMP NULL,
    variables JSON,
    
    FOREIGN KEY (process_id) REFERENCES process_definition(process_id),
    INDEX idx_process_id (process_id),
    INDEX idx_status (status),
    INDEX idx_start_time (start_time)
);
```

#### 4.1.3 任务实例表
```sql
CREATE TABLE task_instance (
    task_id VARCHAR(64) PRIMARY KEY,
    instance_id VARCHAR(64) NOT NULL,
    task_name VARCHAR(255) NOT NULL,
    task_type ENUM('USER_TASK', 'SERVICE_TASK', 'SCRIPT_TASK', 'AGENT_TASK') NOT NULL,
    agent_id VARCHAR(64),
    status ENUM('PENDING', 'RUNNING', 'COMPLETED', 'FAILED', 'SKIPPED') DEFAULT 'PENDING',
    priority INT DEFAULT 0,
    start_time TIMESTAMP NULL,
    end_time TIMESTAMP NULL,
    input_data JSON,
    output_data JSON,
    error_message TEXT,
    
    FOREIGN KEY (instance_id) REFERENCES process_instance(instance_id),
    INDEX idx_instance_id (instance_id),
    INDEX idx_status (status),
    INDEX idx_priority (priority DESC)
);
```

#### 4.1.4 Agent注册表
```sql
CREATE TABLE agent_registry (
    agent_id VARCHAR(64) PRIMARY KEY,
    agent_name VARCHAR(255) NOT NULL,
    agent_type ENUM('LLM', 'TOOL', 'CUSTOM') NOT NULL,
    capabilities JSON,
    endpoint_url VARCHAR(500),
    auth_config JSON,
    status ENUM('ACTIVE', 'INACTIVE', 'MAINTENANCE') DEFAULT 'ACTIVE',
    health_status ENUM('HEALTHY', 'UNHEALTHY', 'UNKNOWN') DEFAULT 'UNKNOWN',
    last_heartbeat TIMESTAMP NULL,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_agent_type (agent_type),
    INDEX idx_status (status),
    INDEX idx_last_heartbeat (last_heartbeat)
);
```

#### 4.1.5 MCP连接表
```sql
CREATE TABLE mcp_connection (
    connection_id VARCHAR(64) PRIMARY KEY,
    model_provider VARCHAR(100) NOT NULL,
    model_name VARCHAR(255) NOT NULL,
    endpoint_url VARCHAR(500) NOT NULL,
    api_key_encrypted VARCHAR(512),
    connection_config JSON,
    status ENUM('CONNECTED', 'DISCONNECTED', 'ERROR') DEFAULT 'DISCONNECTED',
    last_connected TIMESTAMP NULL,
    error_message TEXT,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_provider (model_provider),
    INDEX idx_status (status)
);
```

### 4.2 Redis数据结构设计

#### 4.2.1 任务队列
```
# 优先级任务队列
ai_workflow:task_queue:high     # 高优先级任务
ai_workflow:task_queue:normal   # 普通优先级任务
ai_workflow:task_queue:low      # 低优先级任务

# 任务状态缓存
ai_workflow:task_status:{taskId}  # 任务执行状态

# Agent负载信息
ai_workflow:agent_load:{agentId}  # Agent当前负载
```

#### 4.2.2 会话缓存
```
# MCP连接会话
ai_workflow:mcp_session:{connectionId}  # MCP连接会话信息

# 用户会话
ai_workflow:user_session:{userId}       # 用户会话信息

# 流程执行上下文
ai_workflow:process_context:{instanceId}  # 流程执行上下文
```

---

## 5. API接口设计

### 5.1 流程管理API

#### 5.1.1 创建流程定义
```http
POST /api/v1/processes/definitions
Content-Type: application/json

{
  "processName": "客户服务流程",
  "processKey": "customer_service_flow",
  "bpmnXml": "<bpmn2:definitions>...</bpmn2:definitions>",
  "description": "智能客户服务处理流程"
}

Response 200:
{
  "code": 200,
  "message": "success",
  "data": {
    "processId": "proc_1234567890",
    "version": 1,
    "status": "DRAFT"
  }
}
```

#### 5.1.2 启动流程实例
```http
POST /api/v1/processes/instances
Content-Type: application/json

{
  "processId": "proc_1234567890",
  "businessKey": "order_20240101001",
  "variables": {
    "customerId": "cust_001",
    "orderAmount": 1000.00,
    "priority": "HIGH"
  }
}

Response 200:
{
  "code": 200,
  "message": "success", 
  "data": {
    "instanceId": "inst_1234567890",
    "status": "RUNNING",
    "startTime": "2024-01-01T10:00:00Z"
  }
}
```

### 5.2 Agent管理API

#### 5.2.1 注册Agent
```http
POST /api/v1/agents/register
Content-Type: application/json

{
  "agentName": "智能客服Agent",
  "agentType": "LLM",
  "capabilities": {
    "supportedTasks": ["TEXT_ANALYSIS", "CUSTOMER_SERVICE"],
    "maxConcurrency": 10,
    "supportedLanguages": ["zh-CN", "en-US"]
  },
  "endpointUrl": "http://agent-service:8080/api",
  "authConfig": {
    "type": "API_KEY",
    "apiKey": "encrypted_key"
  }
}

Response 200:
{
  "code": 200,
  "message": "success",
  "data": {
    "agentId": "agent_1234567890",
    "status": "ACTIVE"
  }
}
```

### 5.3 MCP连接API

#### 5.3.1 创建MCP连接
```http
POST /api/v1/mcp/connections
Content-Type: application/json

{
  "modelProvider": "ALIBABA",
  "modelName": "qwen-turbo",
  "endpointUrl": "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation",
  "apiKey": "sk-xxxxxxxxxxxxx",
  "connectionConfig": {
    "maxTokens": 2000,
    "temperature": 0.8,
    "timeout": 30000
  }
}

Response 200:
{
  "code": 200,
  "message": "success",
  "data": {
    "connectionId": "conn_1234567890",
    "status": "CONNECTED"
  }
}
```

---

## 6. 部署架构设计

### 6.1 开发环境
```yaml
# docker-compose.dev.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - MYSQL_URL=jdbc:mysql://mysql:3306/ai_workflow
      - REDIS_URL=redis://redis:6379
    depends_on:
      - mysql
      - redis

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: ai_workflow
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  mysql_data:
  redis_data:
```

### 6.2 生产环境 (Kubernetes)
```yaml
# k8s-deployment.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-workflow-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ai-workflow
  template:
    metadata:
      labels:
        app: ai-workflow
    spec:
      containers:
      - name: app
        image: ai-workflow:latest
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: MYSQL_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: mysql-url
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
---
apiVersion: v1
kind: Service
metadata:
  name: ai-workflow-service
spec:
  selector:
    app: ai-workflow
  ports:
  - port: 80
    targetPort: 8080
  type: LoadBalancer
```

---

## 7. 开发计划

### 7.1 第一阶段 (MVP - 4周)
- [ ] **Week 1**: 项目基础架构搭建
  - Spring Boot项目初始化
  - 数据库表结构设计与创建
  - 基础的Controller/Service/Repository层
  
- [ ] **Week 2**: MCP协议引擎核心功能
  - MCP服务器基础实现
  - 阿里通义千问适配器开发
  - 基础的工具注册和管理
  
- [ ] **Week 3**: 流程引擎核心功能
  - 简单的流程定义和解析
  - 基础任务调度器
  - Agent接口和LLM Agent实现
  
- [ ] **Week 4**: 系统集成和测试
  - MCP引擎与流程引擎集成
  - 基础Web界面开发
  - 端到端测试用例

### 7.2 第二阶段 (完善功能 - 6周)
- [ ] **Week 5-6**: 流程设计器开发
  - 可视化BPMN设计器
  - 流程模板管理
  - 流程验证和测试

- [ ] **Week 7-8**: 高级Agent功能
  - 多Agent协作机制
  - Agent负载均衡
  - 健康检查和故障恢复

- [ ] **Week 9-10**: 监控和运维功能
  - 实时监控面板
  - 日志分析和查询
  - 性能指标收集

### 7.3 第三阶段 (企业级特性 - 4周)
- [ ] **Week 11-12**: 安全和权限
  - 用户认证和授权
  - API安全和限流
  - 数据加密和隐私保护

- [ ] **Week 13-14**: 扩展和集成
  - 更多AI模型适配器
  - 第三方工具集成
  - 开放API和SDK

---

## 8. 总结

本系统设计以**MCP协议支持**和**自研流程编排引擎**为核心，构建了一个企业级的AI工作流编排平台。通过标准化的MCP协议，实现了与多种AI模型的无缝集成；通过灵活的流程引擎，提供了强大的多Agent协作能力。

**核心技术亮点：**
1. 🔗 **MCP协议标准化** - 统一AI模型交互接口
2. ⚙️ **自研流程引擎** - 灵活的工作流编排能力  
3. 🤖 **多Agent协作** - 智能任务分配和协调
4. 🚀 **企业级部署** - 高可用、可扩展的架构设计

**发展路线：**
- 短期：实现MVP功能，验证核心技术方案
- 中期：完善产品功能，提升用户体验
- 长期：构建开放生态，成为AI编排标准平台
